# OCI SSH Sync

**SSH Configuration Generator for Oracle Cloud Infrastructure**

OCI SSH Sync is a Python tool that automatically generates SSH configurations for OKE (Oracle Kubernetes Engine) and ODO (Oracle Digital Office) instances across Oracle Cloud Infrastructure regions. It creates SSH config entries with ProxyCommand for secure bastion-based access to your cloud resources.

## ğŸ¯ Purpose

This tool eliminates the manual process of creating SSH configurations for OCI instances by:

1. **Discovering Resources**: Automatically finds OKE clusters and ODO instances across specified regions
2. **Bastion Matching**: Intelligently matches instances to appropriate bastions for secure access
3. **Configuration Generation**: Creates ready-to-use SSH config entries with ProxyCommand
4. **Multi-Region Support**: Handles resources distributed across multiple OCI regions and realms

## ğŸš€ Quick Start

### Prerequisites

- Python 3.11+ with Poetry
- OCI CLI installed and configured
- Access to Oracle Cloud Infrastructure
- `ossh` command available (Oracle internal tool)

### Installation

```bash
# Clone the repository
git clone <repository-url>
cd oci-python-client

# Install dependencies
make install

# Set up development environment (optional)
make dev-setup
```

### Project Structure

```
oci-python-client/
â”œâ”€â”€ tools/                    # All development tools and source code
â”‚   â”œâ”€â”€ src/                 # Python source code
â”‚   â”‚   â”œâ”€â”€ oci_client/     # Core OCI client library
â”‚   â”‚   â””â”€â”€ ssh_sync.py     # Main SSH sync application
â”‚   â”œâ”€â”€ tests/               # Unit tests
â”‚   â”œâ”€â”€ meta.yaml           # Configuration file
â”‚   â”œâ”€â”€ pyproject.toml      # Poetry dependencies
â”‚   â””â”€â”€ poetry.lock         # Locked dependencies
â”œâ”€â”€ ssh_configs/             # Generated SSH configuration files
â”œâ”€â”€ README.md               # This file
â””â”€â”€ Makefile               # Build and automation commands
```

### Authentication Setup

```bash
# Create initial OCI profile for session token creation
oci session authenticate --profile-name DEFAULT --region us-phoenix-1
```

### Generate SSH Config

```bash
# Generate SSH config for a specific project and stage
make ssh-sync PROJECT=remote-observer STAGE=dev

# Alternative: Use convenience commands
make ssh-sync-remote-observer-dev
make ssh-sync-today-all-staging
```

## ğŸ“‹ Configuration

### YAML Configuration File (`tools/meta.yaml`)

The tool uses a YAML configuration file to define project, stage, and region mappings:

```yaml
projects:
  remote-observer:
    dev:
      oc1:
        us-phoenix-1:
          compartment_id: ocid1.compartment.oc1..aaaaaaaah3k3f5rksyb5iv...
    staging:
      oc1:
        us-ashburn-1:
          compartment_id: ocid1.compartment.oc1..aaaaaaaasrzpupgdi2aa7l...
      oc16:
        us-westjordan-1:
          compartment_id: ocid1.compartment.oc16..aaaaaaaaj7b7evofguzwlw...
    prod:
      oc17:
        us-dcc-phoenix-1:
          compartment_id: ocid1.compartment.oc17..aaaaaaaasaow4j73qa6mf4...
```

### Supported Projects and Stages

- **Projects**: `remote-observer`, `today-all`
- **Stages**: `dev`, `staging`, `prod`
- **Realms**: `oc1`, `oc16`, `oc17`

## ğŸ–¥ï¸ Usage Examples

### Basic Usage

```bash
# Generate SSH config for remote-observer development
make ssh-sync PROJECT=remote-observer STAGE=dev

# Generate SSH config for today-all staging
make ssh-sync PROJECT=today-all STAGE=staging
```

### Convenience Commands

```bash
# Development environments
make ssh-sync-remote-observer-dev
make ssh-sync-today-all-dev

# Staging environments
make ssh-sync-remote-observer-staging
make ssh-sync-today-all-staging

# Production environments
make ssh-sync-remote-observer-prod
make ssh-sync-today-all-prod
```

### Get Help

```bash
# Show all available commands
make help

# Show detailed SSH sync configuration help
make ssh-help
```

## ğŸ“„ Output

The tool generates an SSH configuration file in the `ssh_configs/` directory (created automatically if it doesn't exist), named `ssh_config_<project>_<stage>.txt`, containing:

### Example SSH Config Entry

```bash
# SSH Config for remote-observer (dev)
# Generated by OCI SSH Sync

Host remote-observer-dev-phx-oc1-1
  HostName ocid1.bastion.oc1..bastion123-10.0.1.10
  ProxyCommand ossh proxy -u %r --overlay-bastion --region us-phoenix-1 --compartment ocid1.compartment.oc1..comp123 -- ssh -A -p 22 ztb-internal.bastion.us-phoenix-1.oci.oraclecloud.com -s proxy:%h:%p
  # Type: OKE
  # Private IP: 10.0.1.10
  # Region: us-phoenix-1
  # Cluster: my-cluster

Host odo-remote-observer-dev-phx-oc1-1
  HostName ocid1.bastion.oc1..bastion123-10.0.2.20
  ProxyCommand ossh proxy -u %r --overlay-bastion --region us-phoenix-1 --compartment ocid1.compartment.oc1..comp123 -- ssh -A -p 22 ztb-internal.bastion.us-phoenix-1.oci.oraclecloud.com -s proxy:%h:%p
  # Type: ODO
  # Private IP: 10.0.2.20
  # Region: us-phoenix-1
```

### Using the Generated Config

```bash
# Copy to your SSH config
cat ssh_configs/remote-observer_dev.txt >> ~/.ssh/config

# Connect to an instance
ssh remote-observer-dev-phx-oc1-1
```

## ğŸ—ï¸ Architecture

### Source Code Structure

```
tools/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ oci_client/                 # OCI client library
â”‚   â”‚   â”œâ”€â”€ client.py              # Main OCI client
â”‚   â”‚   â”œâ”€â”€ models.py              # Data models
â”‚   â”‚   â”œâ”€â”€ auth.py                # Authentication handling
â”‚   â”‚   â””â”€â”€ utils/                 # Utility modules
â”‚   â”‚       â”œâ”€â”€ config.py          # YAML configuration loading
â”‚   â”‚       â”œâ”€â”€ display.py         # Rich console output
â”‚   â”‚       â”œâ”€â”€ resources.py       # Resource collection
â”‚   â”‚       â”œâ”€â”€ session.py         # Session token management
â”‚   â”‚       â”œâ”€â”€ ssh_config_generator.py  # SSH config generation
â”‚   â”‚       â””â”€â”€ yamler.py          # YAML parsing utilities
â”‚   â””â”€â”€ ssh_sync.py                # Main SSH sync application
â”œâ”€â”€ tests/                         # Unit tests
â”‚   â”œâ”€â”€ test_auth.py              # Authentication tests
â”‚   â”œâ”€â”€ test_client.py            # OCI client tests
â”‚   â””â”€â”€ test_ssh_sync.py          # SSH sync tests
â””â”€â”€ meta.yaml                     # Configuration file
```

### Key Components

1. **Session Management**: Optimized session token creation and reuse
2. **Resource Discovery**: Automated OKE and ODO instance discovery
3. **Bastion Matching**: Intelligent subnet-to-bastion mapping
4. **SSH Config Generation**: ProxyCommand-based SSH configuration
5. **Multi-Region Support**: Cross-region resource handling

## ğŸ¯ Intelligent Bastion Selection

The tool uses an advanced algorithm to intelligently pair compute instances with the most appropriate bastions for SSH access.

### How Bastion Matching Works

**Network Topology Understanding:**
- **Compute Instances** are deployed in target subnets (e.g., private subnets)
- **Bastions** have a `target_subnet_id` property indicating which subnet they provide access to
- **Pairing Logic**: Instances in `subnet_A` are matched with bastions where `target_subnet_id == subnet_A`

### Multiple Bastion Selection Algorithm

When multiple bastions can access the same subnet, the tool uses intelligent selection:

1. **Find all matching bastions** with the same `target_subnet_id`
2. **Single bastion**: Use it immediately
3. **Multiple bastions**: Apply smart selection logic:
   - Sort bastions alphabetically by name for deterministic ordering
   - Use hash-based selection with instance ID for consistent pairing
   - Same instance always gets the same bastion across multiple runs
   - Distributes instances across available bastions for load balancing

### Selection Benefits

- âœ… **Deterministic**: Same instance always paired with same bastion
- âœ… **Consistent**: Multiple runs produce identical SSH configurations
- âœ… **Load Balanced**: Distributes instances across available bastions
- âœ… **Transparent**: Logs which bastion was selected and why

### Example Selection Output

```bash
# Multiple bastions available for subnet-123
Selected bastion bastion-alpha for instance i-1a2b3c4d (chose 1 of 3 available)
Selected bastion bastion-beta for instance i-5f6g7h8i (chose 2 of 3 available)
Selected bastion bastion-alpha for instance i-9j0k1l2m (chose 1 of 3 available)
```

**Distribution Result:**
```
bastion-alpha: 7 instances (70.0%)
bastion-beta:  3 instances (30.0%)
```

This ensures optimal resource utilization while maintaining consistent SSH access paths.

## ğŸ› ï¸ Development

### Available Commands

```bash
# Development setup
make install              # Install dependencies
make dev-setup           # Complete development setup

# Code quality
make format              # Format code with black and isort
make lint                # Run linting with flake8
make type-check          # Run type checking with mypy

# Testing
make test                # Run all tests
make test-verbose        # Run tests with verbose output
make test-coverage       # Run tests with coverage

# Cleanup
make clean               # Clean up temporary files
```

### Running Tests

```bash
# Run all tests
poetry run pytest

# Run tests with coverage
poetry run pytest --cov=src/oci_client --cov-report=term-missing

# Run specific test file
poetry run pytest tests/test_client.py -v
```

## ğŸ”§ Advanced Configuration

### Custom Configuration File

```bash
# Use a custom YAML configuration file
cd tools && python src/ssh_sync.py remote-observer dev --config-file custom.yaml
```

### Session Token Management

The tool automatically:
- Creates session tokens for each region when needed
- Reuses valid existing session tokens (within 50-minute window)
- Falls back to DEFAULT profile if session creation fails

### Environment Variables

Set these environment variables for additional configuration:

```bash
export OCI_REGION=us-phoenix-1
export OCI_CONFIG_FILE=~/.oci/config
```

## ğŸ“š Examples

### Complete Workflow Example

```bash
# 1. Set up authentication
oci session authenticate --profile-name DEFAULT --region us-phoenix-1

# 2. Generate SSH config for development environment
make ssh-sync PROJECT=remote-observer STAGE=dev

# 3. Review the generated config
cat ssh_configs/remote-observer_dev.txt

# 4. Add to your SSH config
cat ssh_configs/remote-observer_dev.txt >> ~/.ssh/config

# 5. Connect to an instance
ssh remote-observer-dev-phx-oc1-1
```

### Multi-Region Example

The tool automatically handles resources across multiple regions:

```bash
# This command will process all regions defined in meta.yaml for staging
make ssh-sync PROJECT=remote-observer STAGE=staging

# Output includes entries for:
# - us-ashburn-1 (oc1 realm)
# - us-westjordan-1 (oc16 realm)
```

## ğŸ¤ Contributing

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Make your changes
4. Run tests (`make test`)
5. Format code (`make format`)
6. Commit your changes (`git commit -m 'Add amazing feature'`)
7. Push to the branch (`git push origin feature/amazing-feature`)
8. Open a Pull Request

## ğŸ“‹ Requirements

### System Requirements

- Python 3.11+
- Poetry for dependency management
- OCI CLI
- Access to Oracle Cloud Infrastructure

### Python Dependencies

- `oci` - Oracle Cloud Infrastructure Python SDK
- `rich` - Rich console output
- `pyyaml` - YAML configuration parsing
- `click` - Command line interface

## ğŸ”’ Security

- Session tokens are automatically managed and expire after 1 hour
- Bastion-based access ensures secure connections to private instances
- No credentials are stored in the generated SSH config files

## ğŸ“ˆ Monitoring

The tool provides detailed console output including:
- Resource discovery progress
- Session token status
- SSH config generation results
- Error handling and troubleshooting information

## ğŸ› Troubleshooting

### Common Issues

1. **Authentication Failures**
   ```bash
   # Ensure OCI CLI is properly configured
   oci session authenticate --profile-name DEFAULT --region us-phoenix-1
   ```

2. **No Instances Found**
   - Verify compartment IDs in `meta.yaml`
   - Check that resources exist in the specified regions

3. **No Bastions Found**
   - Ensure internal bastions are deployed in the target compartments
   - Verify bastion lifecycle state is ACTIVE

### Debug Mode

Enable verbose logging for troubleshooting:

```bash
# Set debug level logging
export OCI_LOG_LEVEL=DEBUG
make ssh-sync PROJECT=remote-observer STAGE=dev
```

### OKE Instance Detection Troubleshooting

If OKE instances are not being detected correctly, the tool now uses multiple detection methods:

1. **Traditional metadata**: `oke-cluster-display-name` and `oke-initial-node-labels`
2. **Modern metadata**: `oci.oraclecloud.com/oke-cluster-id` and related fields  
3. **Kubernetes metadata**: Generic kubernetes-related metadata
4. **Defined tags**: OKE or Kubernetes-related tag namespaces
5. **Display name patterns**: Names containing 'oke-', 'k8s-', 'kubernetes', 'node-pool'

**Enable debug logging to see detailed detection analysis:**
```bash
export OCI_LOG_LEVEL=DEBUG
make ssh-sync PROJECT=remote-observer STAGE=dev
```

**Common solutions:**
- Check that your OKE instances have proper metadata or tags
- Verify instances are in RUNNING state
- Ensure the tool can access the compartment containing your OKE clusters

## ğŸ“ Support

For issues and questions:

1. Check the troubleshooting section above
2. Review the generated logs for error details
3. Ensure all prerequisites are met
4. Verify OCI CLI configuration and access

---

**OCI SSH Sync** - Simplifying SSH access to Oracle Cloud Infrastructure resources